<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SpaceBucks Marketplace</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.0/ethers.umd.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        max-width: 800px;
        margin: 2rem auto;
        background: #f0f2f5;
        color: #333;
      }
      .container {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .btn {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }
      .btn:hover {
        background: #1976d2;
      }
      .btn-green {
        background: #4caf50;
      }
      .btn-green:hover {
        background: #45a049;
      }
      .btn-gold {
        background: #ffc107;
        color: #333;
      }
      .btn-gold:hover {
        background: #ffb300;
      }
      input,
      textarea {
        width: 100%;
        padding: 12px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
      }

      /* Layout */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .panel {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #eee;
      }

      /* Question Cards */
      .q-card {
        border: 1px solid #e1e4e8;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: white;
      }
      .q-meta {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
      }
      .q-body {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 10px;
      }
      .bounty-tag {
        background: #fff3cd;
        color: #856404;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
      }

      /* Answer Section */
      .answers-area {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed #eee;
        display: none;
      }
      .a-card {
        background: #f1f8ff;
        padding: 10px;
        margin-top: 8px;
        border-radius: 6px;
        font-size: 0.95rem;
      }
      .winner {
        background: #d4edda;
        border: 1px solid #c3e6cb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üöÄ SpaceBucks Exchange</h1>
        <div id="walletInfo">
          <button class="btn" onclick="connectWallet()">
            ü¶ä Connect Wallet
          </button>
        </div>
      </div>

      <div id="appSection" style="display: none">
        <div class="panel">
          <h3>üí∞ Buy SpaceBucks (SPX)</h3>
          <p style="font-size: 0.9rem; color: #666">Rate: 1 ETH = 1000 SPX</p>
          <div style="display: flex; gap: 10px">
            <input
              type="number"
              id="ethAmount"
              placeholder="ETH Amount (e.g. 0.1)"
              step="0.01"
            />
            <button class="btn btn-green" onclick="buyTokens()">Buy SPX</button>
          </div>
          <p><strong>My Balance:</strong> <span id="balance">0</span> SPX</p>
        </div>

        <div class="panel">
          <h3>üìù Ask a Question</h3>
          <textarea
            id="qContent"
            rows="2"
            placeholder="What do you want to know?"
          ></textarea>
          <div style="display: flex; gap: 10px; align-items: center">
            <input
              type="number"
              id="qBounty"
              placeholder="Bounty (SPX)"
              style="width: 150px"
            />
            <button class="btn" onclick="postQuestion()">
              Post with Bounty
            </button>
          </div>
        </div>

        <h3>üî• Live Marketplace</h3>
        <div id="feed">Loading...</div>
      </div>
    </div>

    <script>
      // --- PASTE NEW CONTRACT ADDRESS HERE ---
      const contractAddress = "0x25aa8313aC369332Dc48ef9d28bB3040B36ae6eB";
      // ---------------------------------------

      const abi = [
        "function balanceOf(address) view returns (uint256)",
        "function decimals() view returns (uint8)",
        "function buyTokens() payable",
        "function postQuestion(string content, uint256 bounty)",
        "function postAnswer(uint256 qId, string content)",
        "function awardBounty(uint256 qId, address winner)",
        "event QuestionPosted(uint256 indexed questionId, address indexed author, string content, uint256 bounty)",
        "event AnswerPosted(uint256 indexed questionId, address indexed answerer, string content)",
        "event BountyAwarded(uint256 indexed questionId, address indexed winner, uint256 amount)",
      ];

      let provider, signer, contract, userAddress;

      async function connectWallet() {
        if (!window.ethereum) {
          alert("MetaMask not found");
          return;
        }

        // üîë MUST be first async action
        await window.ethereum.request({
          method: "eth_requestAccounts",
        });

        // Everything else comes AFTER
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();

        contract = new ethers.Contract(contractAddress, abi, signer);

        document.getElementById("appSection").style.display = "block";

        await updateBalance();
        await loadFeed();
      }

      async function updateBalance() {
        try {
          console.log("Updating balance...");
          console.log("User:", userAddress);
          console.log("Contract:", contract.target);

          const raw = await contract.balanceOf(userAddress);
          console.log("Raw balance:", raw.toString());

          const decimals = await contract.decimals();
          document.getElementById("balance").innerText = ethers.formatUnits(
            raw,
            decimals
          );
        } catch (e) {
          console.error("updateBalance failed:", e);
        }
      }

      // --- ACTIONS ---

      async function buyTokens() {
        const eth = document.getElementById("ethAmount").value;
        console.log("eth", eth);

        if (!eth || Number(eth) <= 0) {
          alert("Enter a valid ETH amount");
          return;
        }

        try {
          const tx = await contract.buyTokens({
            value: ethers.parseEther(eth),
          });

          alert("Buying SPX... Please wait.");
          await tx.wait();
          await updateBalance();
          alert("Purchase Successful!");
        } catch (e) {
          console.error(e);
          alert("Transaction failed");
        }
      }

      async function postQuestion() {
        const content = document.getElementById("qContent").value;
        const bounty = document.getElementById("qBounty").value;
        if (!content || !bounty) return alert("Fill in content and bounty!");

        try {
          const bountyWei = ethers.parseUnits(bounty, 18);
          const tx = await contract.postQuestion(content, bountyWei);
          document.getElementById("qContent").value = "Minting...";
          await tx.wait();
          document.getElementById("qContent").value = "";
          loadFeed(); // Refresh
        } catch (e) {
          console.error(e);
          alert("Error: " + e.message);
        }
      }

      async function postAnswer(qId) {
        const content = prompt("Type your answer:");
        if (!content) return;
        try {
          const tx = await contract.postAnswer(qId, content);
          await tx.wait();
          loadFeed();
        } catch (e) {
          console.error(e);
          alert("Error: " + e.message);
        }
      }

      async function selectWinner(qId, winnerAddr) {
        if (!confirm(`Award bounty to ${winnerAddr}?`)) return;
        try {
          const tx = await contract.awardBounty(qId, winnerAddr);
          await tx.wait();
          loadFeed();
          alert("Bounty Awarded!");
        } catch (e) {
          console.error(e);
          alert("Error: " + e.message);
        }
      }

      // --- FEED LOGIC (The Hard Part) ---

      async function loadFeed() {
        console.log("Loading feed...");
        const feed = document.getElementById("feed");
        feed.innerHTML = "";
        // 1. Get Questions
        async function fetchLogs(filter) {
          const latest = await provider.getBlockNumber();
          const STEP = 900;
          let logs = [];
          for (
            let from = Math.max(latest - 5000, 0);
            from <= latest;
            from += STEP
          ) {
            const to = Math.min(from + STEP - 1, latest);
            logs.push(...(await contract.queryFilter(filter, from, to)));
          }
          return logs;
        }
        async function safeFetch(filter) {
          try {
            return await fetchLogs(filter);
          } catch (e) {
            console.warn("Log fetch failed for", filter, e);
            return [];
          }
        }

        const questions = await safeFetch(contract.filters.QuestionPosted());
        const answers = await safeFetch(contract.filters.AnswerPosted());
        const winners = await safeFetch(contract.filters.BountyAwarded());

        const solvedMap = {}; // store which questions are solved
        winners.forEach((w) => (solvedMap[w.args[0]] = true));

        // Render Questions (Newest First)
        questions.reverse().forEach((q) => {
          const qId = q.args[0];
          const author = q.args[1];
          const content = q.args[2];
          const bounty = ethers.formatUnits(q.args[3], 18);
          const isSolved = solvedMap[qId];

          // Filter answers for this question
          const qAnswers = answers.filter((a) => a.args[0] == qId);
          if (questions.length === 0) {
            feed.innerHTML = "<p>No questions yet. Be the first üöÄ</p>";
            return;
          }

          const div = document.createElement("div");

          div.className = "q-card";
          div.innerHTML = `
                <div class="q-meta">
                    <span>${author.substring(0, 6)}...</span>
                    <span class="bounty-tag">${bounty} SPX Bounty</span>
                </div>
                <div class="q-body">${content}</div>
                <div style="font-size:0.9rem; color:#888;">
                    ${
                      isSolved
                        ? '‚úÖ <span style="color:green; font-weight:bold;">SOLVED</span>'
                        : `<button class="btn btn-gold" onclick="postAnswer(${qId})" style="padding:2px 8px; font-size:0.8rem;">Reply</button>`
                    }
                </div>
                <div class="answers-area" style="display:block;">
                    ${qAnswers
                      .map((a) => {
                        const aAuth = a.args[1];
                        const aText = a.args[2];
                        // Show "Select Winner" button ONLY if: You are author AND not solved
                        const showSelect =
                          userAddress.toLowerCase() == author.toLowerCase() &&
                          !isSolved;

                        return `
                        <div class="a-card">
                            <strong>${aAuth.substring(
                              0,
                              6
                            )}...</strong>: ${aText}
                            ${
                              showSelect
                                ? `<button onclick="selectWinner(${qId}, '${aAuth}')" style="float:right; font-size:0.7rem;">üèÜ Select</button>`
                                : ""
                            }
                        </div>`;
                      })
                      .join("")}
                </div>
            `;
          feed.appendChild(div);
        });
      }
    </script>
  </body>
</html>
