<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SpaceBucks Marketplace</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.0/ethers.umd.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        max-width: 800px;
        margin: 2rem auto;
        background: #f0f2f5;
        color: #333;
      }
      .container {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      /* Button Styles */
      .btn {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.2s;
      }
      .btn:hover {
        background: #1976d2;
      }
      .btn-green {
        background: #4caf50;
      }
      .btn-green:hover {
        background: #45a049;
      }
      .btn-gold {
        background: #ffc107;
        color: #333;
      }
      .btn-gold:hover {
        background: #ffb300;
      }

      input,
      textarea {
        width: 100%;
        padding: 12px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-sizing: border-box;
      }

      /* Header & Wallet Badge */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .wallet-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f1f3f4;
        padding: 8px 16px;
        border-radius: 20px;
        border: 1px solid #ddd;
      }
      .wallet-address {
        font-weight: bold;
        color: #2196f3;
        font-family: monospace;
        font-size: 1.1em;
      }
      .wallet-balance {
        font-weight: bold;
        color: #4caf50; /* Green for Tokens */
      }
      .eth-balance {
        font-weight: bold;
        color: #333; /* Dark for ETH */
      }

      .panel {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid #e1e4e8;
      }

      /* Feed Styles */
      .q-card {
        border: 1px solid #e1e4e8;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
        background: white;
        transition: transform 0.1s;
      }
      .q-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      .q-meta {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
      }
      .q-body {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 12px;
        color: #2c3e50;
      }
      .bounty-tag {
        background: #fff3cd;
        color: #856404;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: bold;
        border: 1px solid #ffeeba;
      }

      .answers-area {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px dashed #eee;
      }
      .a-card {
        background: #f8f9fa;
        padding: 10px 14px;
        margin-top: 8px;
        border-radius: 8px;
        font-size: 0.95rem;
        border-left: 3px solid #ccc;
      }
      .winner {
        background: #d4edda;
        border-left: 3px solid #28a745;
        color: #155724;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üöÄ SpaceBucks</h1>
        <div id="walletInfo">
          <button class="btn" onclick="connectWallet()">
            ü¶ä Connect Wallet
          </button>
        </div>
      </div>

      <div id="appSection" style="display: none">
        <div class="panel">
          <h3>üí∞ Buy SpaceBucks</h3>
          <p style="font-size: 0.9rem; color: #666">
            Exchange Rate: 1 ETH = 1000 SPX
          </p>
          <div style="display: flex; gap: 10px">
            <input
              type="number"
              id="ethAmount"
              placeholder="ETH Amount (e.g. 0.1)"
              step="0.01"
            />
            <button class="btn btn-green" onclick="buyTokens()">
              Buy Tokens
            </button>
          </div>
        </div>

        <div class="panel">
          <h3>üìù Ask the Community</h3>
          <textarea
            id="qContent"
            rows="2"
            placeholder="What is your question?"
          ></textarea>
          <div
            style="
              display: flex;
              gap: 10px;
              align-items: center;
              margin-top: 10px;
            "
          >
            <input
              type="number"
              id="qBounty"
              placeholder="Bounty (SPX)"
              style="width: 150px"
            />
            <button class="btn" onclick="postQuestion()">
              Post with Bounty
            </button>
          </div>
        </div>

        <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px">
          üî• Live Questions
        </h3>
        <div id="feed">Loading...</div>
      </div>
    </div>

    <script>
      // --- CONFIGURATION ---
      const contractAddress = "0x8F9d3de59C77c4522f1C62cDb1F386a792D0D138"; // <--- PASTE YOUR ADDRESS
      // ---------------------

      const abi = [
        "function balanceOf(address) view returns (uint256)",
        "function decimals() view returns (uint8)",
        "function buyTokens() payable",
        "function postQuestion(string content, uint256 bounty)",
        "function postAnswer(uint256 qId, string content)",
        "function awardBounty(uint256 qId, address winner)",
        "event QuestionPosted(uint256 indexed questionId, address indexed author, string content, uint256 bounty)",
        "event AnswerPosted(uint256 indexed questionId, address indexed answerer, string content)",
        "event BountyAwarded(uint256 indexed questionId, address indexed winner, uint256 amount)",
      ];

      let provider, signer, contract, userAddress, userBalance;

      // 1. Auto-Connect on Load
      window.onload = async () => {
        if (window.ethereum) {
          // Listen for account changes
          window.ethereum.on("accountsChanged", handleAccountsChanged);
          window.ethereum.on("chainChanged", () => window.location.reload());

          // Check if already connected
          const accounts = await window.ethereum.request({
            method: "eth_accounts",
          });
          if (accounts.length > 0) {
            connectWallet();
          }
        }
      };

      async function handleAccountsChanged(accounts) {
        if (accounts.length === 0) {
          console.log("Please connect to MetaMask.");
          window.location.reload();
        } else {
          // Re-connect with new account
          connectWallet();
        }
      }

      async function connectWallet() {
        if (!window.ethereum) return alert("Install MetaMask!");

        provider = new ethers.BrowserProvider(window.ethereum);
        // Request Access
        await window.ethereum.request({ method: "eth_requestAccounts" });

        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(contractAddress, abi, signer);

        // Update UI
        document.getElementById("appSection").style.display = "block";
        updateHeader();
        loadFeed();
      }

      async function updateHeader() {
        if (!contract) return;
        try {
          // 1. Get SpaceBucks Balance
          const rawToken = await contract.balanceOf(userAddress);
          userBalance = ethers.formatUnits(rawToken, 18);

          // 2. Get ETH Balance (Added Feature)
          const rawEth = await provider.getBalance(userAddress);
          const ethBalance = ethers.formatEther(rawEth);

          // Shorten Address: 0x1234...5678
          const shortAddr =
            userAddress.substring(0, 6) + "..." + userAddress.substring(38);

          const badgeHTML = `
                <div class="wallet-badge">
                    <span class="eth-balance">${parseFloat(ethBalance).toFixed(
                      4
                    )} ETH</span>
                    <span style="color:#ddd">|</span>
                    <span class="wallet-balance">${parseFloat(
                      userBalance
                    ).toFixed(1)} SPX</span>
                    <span style="color:#ddd">|</span>
                    <span class="wallet-address" title="${userAddress}">${shortAddr}</span>
                </div>
            `;
          document.getElementById("walletInfo").innerHTML = badgeHTML;
        } catch (e) {
          console.error("Balance Error:", e);
        }
      }

      // --- ACTIONS ---

      async function buyTokens() {
        const eth = document.getElementById("ethAmount").value;
        if (!eth) return;
        try {
          const tx = await contract.buyTokens({
            value: ethers.parseEther(eth),
            gasLimit: 300000, // Force gas limit for Ganache
          });
          await tx.wait();
          updateHeader(); // Refresh header balance
          alert("Bought SPX Successfully!");
        } catch (e) {
          console.error(e);
          alert("Error: " + e.message);
        }
      }

      async function postQuestion() {
        const content = document.getElementById("qContent").value;
        const bounty = document.getElementById("qBounty").value;
        if (!content || !bounty) return alert("Fill in content and bounty!");

        try {
          const bountyWei = ethers.parseUnits(bounty, 18);
          const tx = await contract.postQuestion(content, bountyWei);
          document.getElementById("qContent").value = "Minting...";
          await tx.wait();

          document.getElementById("qContent").value = "";
          updateHeader(); // Refresh header balance (bounty deducted)
          loadFeed();
        } catch (e) {
          console.error(e);
          alert("Error: " + e.message);
        }
      }

      async function postAnswer(qId) {
        const content = prompt("Type your answer:");
        if (!content) return;
        try {
          const tx = await contract.postAnswer(qId, content);
          await tx.wait();
          loadFeed();
        } catch (e) {
          console.error(e);
          alert("Error: " + e.message);
        }
      }

      async function selectWinner(qId, winnerAddr) {
        if (!confirm(`Award bounty to ${winnerAddr}?`)) return;
        try {
          const tx = await contract.awardBounty(qId, winnerAddr);
          await tx.wait();
          updateHeader();
          loadFeed();
          alert("Bounty Awarded!");
        } catch (e) {
          console.error(e);
          alert("Error: " + e.message);
        }
      }

      // --- FEED LOGIC (Using "earliest" for Ganache) ---

      async function loadFeed() {
        const feed = document.getElementById("feed");
        feed.innerHTML = "";

        const qFilter = contract.filters.QuestionPosted();
        const aFilter = contract.filters.AnswerPosted();
        const wFilter = contract.filters.BountyAwarded();

        // Use "earliest" to prevent Ganache errors
        const [questions, answers, winners] = await Promise.all([
          contract.queryFilter(qFilter, "earliest", "latest"),
          contract.queryFilter(aFilter, "earliest", "latest"),
          contract.queryFilter(wFilter, "earliest", "latest"),
        ]);

        const solvedMap = {};
        winners.forEach((w) => (solvedMap[w.args[0]] = true));

        questions.reverse().forEach((q) => {
          const qId = q.args[0];
          const author = q.args[1];
          const content = q.args[2];
          const bounty = ethers.formatUnits(q.args[3], 18);
          const isSolved = solvedMap[qId];

          const qAnswers = answers.filter((a) => a.args[0] == qId);

          const div = document.createElement("div");
          div.className = "q-card";
          div.innerHTML = `
                <div class="q-meta">
                    <span style="font-weight:bold; color:#555;">${author.substring(
                      0,
                      6
                    )}...</span>
                    <span class="bounty-tag">${bounty} SPX</span>
                </div>
                <div class="q-body">${content}</div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    ${
                      isSolved
                        ? '<span style="color:green; font-weight:bold;">‚úÖ SOLVED</span>'
                        : `<button class="btn btn-gold" onclick="postAnswer(${qId})" style="padding:4px 10px; font-size:0.8rem;">Reply</button>`
                    }
                    <span style="font-size:0.8rem; color:#888;">${
                      qAnswers.length
                    } Answers</span>
                </div>
                <div class="answers-area" style="display:block;">
                    ${qAnswers
                      .map((a) => {
                        const aAuth = a.args[1];
                        const aText = a.args[2];
                        const showSelect =
                          userAddress.toLowerCase() == author.toLowerCase() &&
                          !isSolved;
                        const isWinner = winners.some(
                          (w) =>
                            w.args[0] == qId &&
                            w.args[1].toLowerCase() == aAuth.toLowerCase()
                        );

                        return `
                        <div class="a-card ${isWinner ? "winner" : ""}">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${aAuth.substring(0, 6)}...</strong>
                                ${
                                  showSelect
                                    ? `<button onclick="selectWinner(${qId}, '${aAuth}')" style="cursor:pointer; border:1px solid #ccc; background:#fff; border-radius:4px;">üèÜ Award</button>`
                                    : ""
                                }
                                ${isWinner ? "<span>üèÜ WINNER</span>" : ""}
                            </div>
                            <div style="margin-top:4px;">${aText}</div>
                        </div>`;
                      })
                      .join("")}
                </div>
            `;
          feed.appendChild(div);
        });
      }
    </script>
  </body>
</html>
